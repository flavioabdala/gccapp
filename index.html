<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Contratos e Lembretes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para a fonte Inter */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }

        /* Animação de piscar para contratos vencendo */
        @keyframes pulse-red {
            0%, 100% { border-color: #ef4444; } /* red-500 */
            50% { border-color: #f87171; } /* red-400 */
        }
        .animate-pulse-red {
            animation: pulse-red 1.5s infinite;
        }

        /* Estilos para o modal de alerta e confirmação */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <div id="loading-spinner" class="fixed inset-0 bg-gray-200 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-purple-500"></div>
            <p class="mt-4 text-gray-700 text-lg">A carregar...</p>
        </div>
    </div>

    <div id="customAlertModal" class="modal-overlay hidden">
        <div class="modal-content border border-yellow-400">
            <div class="flex items-center justify-center mb-4">
                <span class="text-yellow-500 text-4xl mr-3">⚠️</span>
                <h5 class="text-2xl font-bold text-gray-800">Atenção!</h5>
            </div>
            <div id="alertMessages" class="mb-6"></div>
            <button id="alertCloseButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out">
                OK
            </button>
        </div>
    </div>

    <div id="customConfirmModal" class="modal-overlay hidden">
        <div class="modal-content border border-red-500">
            <div class="flex items-center justify-center mb-4">
                <span class="text-red-500 text-4xl mr-3">❓</span>
                <h5 class="text-2xl font-bold text-gray-800">Confirmação</h5>
            </div>
            <p id="confirmMessage" class="text-gray-700 text-base mb-8"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirmCancelButton" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out">
                    Cancelar
                </button>
                <button id="confirmActionButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <div id="auth-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-700 to-indigo-800 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
            <h2 id="auth-title" class="text-4xl font-extrabold text-center text-gray-800 mb-2">Bem-vindo!</h2>
            <p class="text-center text-gray-600 text-lg mb-8">Gestão de Contratos</p>

            <div class="mb-4">
                <input
                    id="auth-email"
                    class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                    placeholder="Email"
                    type="email"
                    autocapitalize="none"
                    autocomplete="email"
                />
            </div>
            <div class="mb-6">
                <input
                    id="auth-password"
                    class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                    placeholder="Palavra-passe"
                    type="password"
                    autocomplete="current-password"
                />
            </div>
            <div id="register-fields" class="hidden">
                <div class="mb-4">
                    <input
                        id="auth-fullName"
                        class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        placeholder="Nome Completo"
                        autocomplete="name"
                    />
                </div>
                <div class="mb-4">
                    <input
                        id="auth-cpf"
                        class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        placeholder="CPF"
                        inputmode="numeric"
                    />
                </div>
                <div class="mb-6">
                    <input
                        id="auth-phone"
                        class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        placeholder="Telefone de Contacto"
                        inputmode="tel"
                        autocomplete="tel"
                    />
                </div>
            </div>
            <div class="flex justify-end">
                <button
                    id="auth-action-button"
                    class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
                >
                    Login
                </button>
            </div>
            <button
                id="toggle-auth-mode-button"
                class="w-full mt-6 text-purple-600 hover:text-purple-800 font-semibold text-center"
            >
                Não tem uma conta? Registe-se
            </button>
        </div>
    </div>

    <div id="main-app-content" class="hidden flex-1 flex flex-col">
        <header class="bg-white shadow-md p-4 mb-4 rounded-b-3xl">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <div class="flex items-center mb-3 sm:mb-0">
                    <h1 class="text-3xl font-bold text-purple-700 mr-4">Gestão de Contratos</h1>
                    <span class="text-gray-600 hidden md:block text-sm">
                        <span id="user-email-display"></span> (<span id="user-role-display"></span>) - UID: <span id="user-id-display"></span>
                    </span>
                </div>
                <nav class="flex flex-wrap justify-center sm:justify-end gap-2">
                    <button
                        id="nav-list-button"
                        class="px-4 py-2 rounded-lg font-semibold transition duration-200 bg-purple-600 text-white shadow-md"
                    >
                        Contratos
                    </button>
                    <button
                        id="nav-register-button"
                        class="px-4 py-2 rounded-lg font-semibold transition duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300"
                    >
                        Registrar Contrato
                    </button>
                    <button
                        id="nav-reminders-button"
                        class="px-4 py-2 rounded-lg font-semibold transition duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300"
                    >
                        Lembretes
                    </button>
                    <button
                        id="logout-button"
                        class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200"
                    >
                        Sair
                    </button>
                </nav>
            </div>
        </header>

        <main class="container mx-auto px-4 py-6 flex-1">
            <section id="contracts-list-section" class="mb-8 p-6 bg-white rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold text-gray-800 text-center mb-6">Lista de Contratos</h2>
                <div id="contracts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="col-span-full text-center text-gray-600 text-lg">Nenhum contrato encontrado. Clique em "Registrar Contrato" para adicionar um novo.</p>
                </div>
            </section>

            <section id="register-contract-section" class="hidden mb-8 p-6 bg-white rounded-2xl shadow-lg max-w-3xl mx-auto">
                <h2 id="register-contract-title" class="text-3xl font-bold text-gray-800 text-center mb-6">Registrar Novo Contrato</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Processo SEI:</label>
                        <input id="input-processoSCEI" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Ex: 12345.67890/2023-00" />
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Nome da Empresa:</label>
                        <input id="input-nomeEmpresa" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Nome Completo da Empresa" />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Objeto da Contratação:</label>
                        <textarea id="input-objetoContratacao" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 h-24 resize-y" placeholder="Detalhes do que está sendo contratado"></textarea>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Número do Contrato:</label>
                        <input id="input-numeroContrato" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Ex: 001/2023" />
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Início Vigência Total:</label>
                        <input type="date" id="input-inicioVigenciaTotal" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Momento Atual do Contrato:</label>
                        <select id="select-momentoAtual" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Término Atual do Contrato:</label>
                        <input type="date" id="input-terminoAtualContrato" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Tipo de Lei:</label>
                        <select id="select-lawType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Valor do Contrato (R$):</label>
                        <input id="input-valorContrato" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Ex: 1.234.567,89" inputmode="decimal" />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Unidades Participantes:</label>
                        <div id="unidades-checkboxes" class="flex flex-wrap gap-2">
                            </div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Últimas Movimentações:</label>
                        <textarea id="input-ultimasMovimentacoes" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 h-32 resize-y" placeholder="Histórico de movimentações do contrato"></textarea>
                    </div>
                </div>
                <button id="add-update-contract-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 mb-4">
                    Adicionar Contrato
                </button>
                <button id="cancel-edit-button" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 hidden">
                    Cancelar Edição
                </button>
            </section>

            <section id="reminders-section" class="hidden mb-8 p-6 bg-white rounded-2xl shadow-lg max-w-2xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 text-center mb-6">Meus Lembretes</h2>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-semibold mb-2">Novo Lembrete:</label>
                    <input id="input-reminderText" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 mb-3" placeholder="Texto do lembrete" />
                    <input type="date" id="input-reminderDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 mb-4" />
                    <button id="add-reminder-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                        Adicionar Lembrete
                    </button>
                </div>

                <h3 class="text-xl font-bold text-gray-800 border-t pt-6 mt-6">Lembretes Existentes:</h3>
                <ul id="reminders-list" class="space-y-4 mt-4">
                    <p class="text-center text-gray-600 text-lg mt-4">Nenhum lembrete adicionado ainda.</p>
                </ul>
            </section>
        </main>
    </div>

    <script type="module">
        // Importa os módulos necessários do Firebase a partir de CDNs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, Timestamp, doc, updateDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration Variables ---
        // AS SUAS CREDENCIAIS FIREBASE REAIS - OBTIDAS DO SEU CONSOLE FIREBASE.
        // VOCÊ DEVE SUBSTITUIR TODO O BLOCO 'const firebaseConfig = { ... }' ABAIXO
        // PELAS SUAS PRÓPRIAS CREDENCIAIS.
        const firebaseConfig = {
            apiKey: "AIzaSyDTxRQdMy4QugmySVeSErf5Kqihn_4OhWw", // Ex: "AIzaSyDTxRQdMy4QugmySVeSErf5Kqihn_4OhWw"
            authDomain: "gcc-contratos.firebaseapp.com", // Ex: "gcc-contratos.firebaseapp.com"
            projectId: "gcc-contratos", // Ex: "gcc-contratos"
            storageBucket: "cc-contratos.firebasestorage.app", // Ex: "gcc-contratos.appspot.com"
            messagingSenderId: "405415511927", // Ex: "405415511927"
            appId: "1:405415511927:web:4612190119302726820372", // Ex: "1:405415511927:web:4612190119302726820372"
        };
        // O appId será o mesmo que o projectId para consistência com as coleções do Firestore.
        const appId = firebaseConfig.projectId; // Define appId com o projectId real do seu firebaseConfig

        // --- Firebase Setup and Initialization ---
        let app;
        let db;
        let auth;
        let userId = '';
        let userEmail = '';
        let isAdmin = false;
        let isLoggedIn = false;
        let currentEditingContract = null; // Stores the contract being edited

        // Inicializa o Firebase apenas se as credenciais forem válidas
        if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "SUA_API_KEY_AQUI") {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase inicializado com sucesso.");
                // Configura a persistência para 'NONE' para evitar login automático
                auth.setPersistence(firebase.auth.Auth.Persistence.NONE)
                    .then(() => console.log("Persistência de autenticação definida para 'NONE'."))
                    .catch((error) => console.error("Erro ao definir persistência de autenticação:", error));
            } catch (error) {
                console.error('Erro ao inicializar Firebase. Verifique suas credenciais:', error);
                displayAlert(["Erro: O sistema de base de dados não foi inicializado. Por favor, forneça suas credenciais Firebase e recarregue a página."]);
            }
        } else {
            console.warn("firebaseConfig está vazio ou contém placeholders. O Firebase não será inicializado até que as credenciais sejam fornecidas.");
            displayAlert(["Aviso: As credenciais do Firebase não foram configuradas. O aplicativo não funcionará corretamente. Por favor, edite o código para adicionar suas credenciais."]);
        }

        // =============================================================================
        // IMPORTANTE: VOCÊ DEVE SUBSTITUIR "txHwdn3rwubSff4PvekjO4PM7wb2" PELO SEU UID DE UTILIZADOR REAL.
        // Após registar e fazer login pela primeira vez, o seu UID será exibido na tela principal.
        // Copie-o e cole-o aqui para se tornar o administrador.
        // Exemplo: const ADMIN_UIDs = ['AbCdeFgHijKlmNoPqrStUvWxyZ12345'];
        const ADMIN_UIDs = ['txHwdn3rwubSff4PvekjO4PM7wb2', 'xo7oBxVSn8QeUx3HvAl8gO3Mq2w1']; // <<< MUDE AQUI!
        // =============================================================================

        // --- DOM Elements ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const customAlertModal = document.getElementById('customAlertModal');
        const alertMessagesDiv = document.getElementById('alertMessages');
        const alertCloseButton = document.getElementById('alertCloseButton');
        const customConfirmModal = document.getElementById('customConfirmModal');
        const confirmMessageP = document.getElementById('confirmMessage');
        const confirmCancelButton = document.getElementById('confirmCancelButton');
        const confirmActionButton = document.getElementById('confirmActionButton');

        const authScreen = document.getElementById('auth-screen');
        const authTitle = document.getElementById('auth-title');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const registerFieldsDiv = document.getElementById('register-fields');
        const authFullNameInput = document.getElementById('auth-fullName');
        const authCpfInput = document.getElementById('auth-cpf');
        const authPhoneInput = document.getElementById('auth-phone');
        const authActionButton = document.getElementById('auth-action-button');
        const toggleAuthModeButton = document.getElementById('toggle-auth-mode-button');

        const mainAppContent = document.getElementById('main-app-content');
        const userEmailDisplay = document.getElementById('user-email-display');
        const userRoleDisplay = document.getElementById('user-role-display');
        const userIdDisplay = document.getElementById('user-id-display');
        const navListButton = document.getElementById('nav-list-button');
        const navRegisterButton = document.getElementById('nav-register-button');
        const navRemindersButton = document.getElementById('nav-reminders-button');
        const logoutButton = document.getElementById('logout-button');

        const contractsListSection = document.getElementById('contracts-list-section');
        const contractsGrid = document.getElementById('contracts-grid');

        const registerContractSection = document.getElementById('register-contract-section');
        const registerContractTitle = document.getElementById('register-contract-title');
        const inputProcessoSCEI = document.getElementById('input-processoSCEI');
        const inputNomeEmpresa = document.getElementById('input-nomeEmpresa');
        const inputObjetoContratacao = document.getElementById('input-objetoContratacao');
        const inputNumeroContrato = document.getElementById('input-numeroContrato');
        const inputInicioVigenciaTotal = document.getElementById('input-inicioVigenciaTotal');
        const selectMomentoAtual = document.getElementById('select-momentoAtual');
        const inputTerminoAtualContrato = document.getElementById('input-terminoAtualContrato');
        const selectLawType = document.getElementById('select-lawType');
        const inputValorContrato = document.getElementById('input-valorContrato');
        const unidadesCheckboxes = document.getElementById('unidades-checkboxes');
        const inputUltimasMovimentacoes = document.getElementById('input-ultimasMovimentacoes');
        const addUpdateContractButton = document.getElementById('add-update-contract-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');

        const remindersSection = document.getElementById('reminders-section');
        const inputReminderText = document.getElementById('input-reminderText');
        const inputReminderDate = document.getElementById('input-reminderDate');
        const addReminderButton = document.getElementById('add-reminder-button');
        const remindersList = document.getElementById('reminders-list');

        // --- Global State Variables ---
        let currentAlertMessages = [];
        let currentConfirmAction = null;
        let isRegistering = false;
        let contractsData = [];
        let remindersData = [];
        const processColors = {}; // To store colors for each Processo SEI
        const colorPalette = [
            '#DBEAFE', '#D1FAE5', '#FEE2E2', '#FEF9C3', '#EDE9FE', '#FCE7F3', '#EEF2FF',
            '#CCFBF1', '#FFEDD5', '#ECFCCB', '#CFFAFE', '#FAE8FF', '#FFE4E6', '#E0F2FE',
            '#F5F3FF', '#FFFBEB', '#E5E7EB'
        ];

        // Options for form fields
        const momentoAtualOptions = [
            'Inicial', 'Primeira Renovação', 'Segunda Renovação', 'Terceira Renovação',
            'Quarta Renovação', 'Quinta Renovação', 'Sexta Renovação', 'Sétima Renovação',
            'Oitava Renovação', 'Nona Renovação', 'Décima Renovação', 'Não haverá renovação',
        ];
        const lawTypeOptions = [
            'Lei 8.666/93 (60 meses)', 'Lei 14.133/21 (10 anos)',
        ];
        const unidadesDisponiveis = [
            'HJXXIII', 'HIJPII', 'HMAL', 'HEM', 'HAC', 'HRJP', 'CHB', 'HRBJA',
            'CSSFA', 'CSSFE', 'CSSI', 'HRAD', 'HCM', 'MOV', 'HJK', 'CSPD', 'IRS', 'HRB'
        ];

        // --- Utility Functions ---

        /**
         * Shows the loading spinner.
         */
        function showLoading() {
            loadingSpinner.classList.remove('hidden');
        }

        /**
         * Hides the loading spinner.
         */
        function hideLoading() {
            loadingSpinner.classList.add('hidden');
        }

        /**
         * Displays a custom alert modal with given messages.
         * @param {Array<string>} messages - An array of messages to display.
         */
        function displayAlert(messages) {
            currentAlertMessages = messages;
            alertMessagesDiv.innerHTML = messages.map(msg => `<p class="text-gray-700 text-base mb-1">${msg}</p>`).join('');
            customAlertModal.classList.remove('hidden');
        }

        /**
         * Hides the custom alert modal.
         */
        function hideAlert() {
            customAlertModal.classList.add('hidden');
            currentAlertMessages = [];
        }

        /**
         * Displays a custom confirmation modal.
         * @param {string} message - The confirmation message.
         * @param {Function} onConfirmAction - The function to execute if confirmed.
         */
        function displayConfirm(message, onConfirmAction) {
            confirmMessageP.textContent = message;
            currentConfirmAction = onConfirmAction;
            customConfirmModal.classList.remove('hidden');
        }

        /**
         * Hides the custom confirmation modal.
         */
        function hideConfirm() {
            customConfirmModal.classList.add('hidden');
            currentConfirmAction = null;
            confirmMessageP.textContent = '';
        }

        /**
         * Handles the confirmation action.
         */
        function handleConfirm() {
            if (currentConfirmAction) {
                currentConfirmAction();
            }
            hideConfirm();
        }

        /**
         * Handles the cancellation of the confirmation action.
         */
        function handleCancelConfirm() {
            hideConfirm();
        }

        /**
         * Converts DD/MM/YYYY string to YYYY-MM-DD for input type="date".
         * @param {string} dateStr - Date string in DD/MM/YYYY format.
         * @returns {string} Date string in YYYY-MM-DD format or empty string.
         */
        function formatDateForInput(dateStr) {
            if (!dateStr || !dateStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) return '';
            const [day, month, year] = dateStr.split('/');
            return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }

        /**
         * Converts YYYY-MM-DD string to DD/MM/YYYY.
         * @param {string} dateStr - Date string in YYYY-MM-DD format.
         * @returns {string} Date string in DD/MM/YYYY format.
         */
        function formatDateFromInput(dateStr) {
            if (!dateStr || !dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) return '';
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        }

        /**
         * Calculates the legal termination date based on start date and law type.
         * @param {string} inicioVigenciaStr - Start date in DD/MM/YYYY.
         * @param {string} contractLawType - Type of law (e.g., 'Lei 8.666/93 (60 meses)').
         * @returns {string} Legal termination date in DD/MM/YYYY or error message.
         */
        function calcularTerminoLegal(inicioVigenciaStr, contractLawType) {
            if (!inicioVigenciaStr || !inicioVigenciaStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return 'Data de início inválida';
            }

            const [day, month, year] = inicioVigenciaStr.split('/').map(Number);
            const startDate = new Date(year, month - 1, day);

            let monthsToAddTotal = 0;
            if (contractLawType === 'Lei 8.666/93 (60 meses)') {
                monthsToAddTotal = 60; // 5 anos
            } else if (contractLawType === 'Lei 14.133/21 (10 anos)') {
                monthsToAddTotal = 120; // 10 anos
            } else {
                return 'Tipo de lei inválido';
            }

            const endDate = new Date(startDate);
            endDate.setMonth(endDate.getMonth() + monthsToAddTotal);

            // Adjust day if it overflows (e.g., Jan 31 + 1 month = Feb 28/29, not Mar 3)
            if (endDate.getDate() !== day) {
                endDate.setDate(0); // Set to last day of previous month
            }

            const formattedDay = String(endDate.getDate()).padStart(2, '0');
            const formattedMonth = String(endDate.getMonth() + 1).padStart(2, '0');
            const formattedYear = endDate.getFullYear();
            return `${formattedDay}/${formattedMonth}/${formattedYear}`;
        }

        /**
         * Formats a number from Firebase (e.g., 1234567.89) to display string (e.g., "1.234.567,89").
         * @param {number} numValue - The number value from Firebase.
         * @returns {string} Formatted currency string.
         */
        function formatNumberFromFirebaseForDisplay(numValue) {
            if (numValue === null || numValue === undefined || isNaN(numValue)) {
                return '';
            }
            const number = typeof numValue === 'string' ? parseFloat(numValue) : numValue;
            if (isNaN(number)) return '';
            return number.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2, useGrouping: true });
        }

        /**
         * Parses a formatted currency string (e.g., "1.234.567,89") to a number for Firebase (e.g., 1234567.89).
         * @param {string} formattedValue - The formatted currency string.
         * @returns {number|null} Parsed number or null if invalid.
         */
        function parseValorContratoForSave(formattedValue) {
            if (!formattedValue) return null;
            const cleaned = formattedValue.replace(/\./g, '').replace(/,/g, '.');
            const number = parseFloat(cleaned);
            return isNaN(number) ? null : number;
        }

        /**
         * Handles the input change for valorContrato, formatting it as currency.
         * @param {Event} e - The input event.
         */
        function handleValorContratoInputChange(e) {
            let value = e.target.value;
            let cleanedValue = value.replace(/[^0-9]/g, '');
            if (cleanedValue === '' || cleanedValue === '0') {
                inputValorContrato.value = cleanedValue;
                return;
            }
            if (cleanedValue.length < 3) {
                cleanedValue = cleanedValue.padStart(3, '0');
            }
            let integerPart = cleanedValue.slice(0, -2);
            let decimalPart = cleanedValue.slice(-2);
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            const formattedValue = `${integerPart},${decimalPart}`;
            inputValorContrato.value = formattedValue;
        }

        /**
         * Checks if a contract is expiring soon (within 180 days).
         * @param {Object} contract - The contract object.
         * @returns {boolean} True if expiring soon, false otherwise.
         */
        function isExpiringSoon(contract) {
            if (!contract.terminoAtualContrato) return false;
            const [day, month, year] = contract.terminoAtualContrato.split('/').map(Number);
            const endDate = new Date(year, month - 1, day);
            const today = new Date();
            const diffTime = endDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays <= 180 && diffDays > 0;
        }

        // --- UI Rendering Functions ---

        /**
         * Sets the current active page and updates navigation button styles.
         * @param {string} page - The page to show ('list', 'register', 'reminders').
         */
        function setPage(page) {
            contractsListSection.classList.add('hidden');
            registerContractSection.classList.add('hidden');
            remindersSection.classList.add('hidden');

            navListButton.classList.remove('bg-purple-600', 'text-white', 'shadow-md');
            navListButton.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');

            navRegisterButton.classList.remove('bg-purple-600', 'text-white', 'shadow-md');
            navRegisterButton.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');

            navRemindersButton.classList.remove('bg-purple-600', 'text-white', 'shadow-md');
            navRemindersButton.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');

            if (page === 'list') {
                contractsListSection.classList.remove('hidden');
                navListButton.classList.add('bg-purple-600', 'text-white', 'shadow-md');
                navListButton.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            } else if (page === 'register') {
                registerContractSection.classList.remove('hidden');
                navRegisterButton.classList.add('bg-purple-600', 'text-white', 'shadow-md');
                navRegisterButton.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            } else if (page === 'reminders') {
                remindersSection.classList.remove('hidden');
                navRemindersButton.classList.add('bg-purple-600', 'text-white', 'shadow-md');
                navRemindersButton.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            }
        }

        /**
         * Renders the list of contracts in the contracts grid.
         * @param {Array<Object>} contracts - Array of contract objects.
         */
        function renderContracts(contracts) {
            contractsGrid.innerHTML = ''; // Clear existing contracts

            if (contracts.length === 0) {
                contractsGrid.innerHTML = '<p class="col-span-full text-center text-gray-600 text-lg">Nenhum contrato encontrado. ' + (isAdmin ? 'Clique em "Registrar Contrato" para adicionar um novo.' : '') + '</p>';
                return;
            }

            // Sort contracts: expiring soon first, then by Processo SEI
            const sortedContracts = [...contracts].sort((a, b) => {
                const aExpiring = isExpiringSoon(a);
                const bExpiring = isExpiringSoon(b);

                if (aExpiring && !bExpiring) return -1;
                if (!aExpiring && bExpiring) return 1;

                return (a.processoSCEI || '').localeCompare(b.processoSCEI || '');
            });


            sortedContracts.forEach(contract => {
                // Assign a color to each unique Processo SEI
                if (!processColors[contract.processoSCEI]) {
                    processColors[contract.processoSCEI] = colorPalette[Object.keys(processColors).length % colorPalette.length];
                }

                const contractCard = document.createElement('div');
                contractCard.className = `relative p-6 rounded-2xl shadow-md border ${isExpiringSoon(contract) ? 'border-red-500 animate-pulse-red' : 'border-gray-200'}`;
                contractCard.style.backgroundColor = processColors[contract.processoSCEI] || '#FFFFFF';

                let expiringSoonTag = '';
                if (isExpiringSoon(contract)) {
                    const [day, month, year] = contract.terminoAtualContrato.split('/').map(Number);
                    const endDate = new Date(year, month - 1, day);
                    const today = new Date();
                    const diffTime = endDate.getTime() - today.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    expiringSoonTag = `
                        <span class="absolute top-3 right-3 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-sm">
                            ⚠ VENCENDO EM ${diffDays} DIAS!
                        </span>
                    `;
                }

                contractCard.innerHTML = `
                    ${expiringSoonTag}
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${contract.nomeEmpresa || 'N/A'}</h3>
                    <p class="text-gray-600 text-sm mb-1">Processo SEI: <span class="font-semibold">${contract.processoSCEI || 'N/A'}</span></p>
                    <p class="text-gray-600 text-sm mb-1">Objeto: ${contract.objetoContratacao || 'N/A'}</p>
                    <p class="text-gray-600 text-sm mb-1">Número do Contrato: ${contract.numeroContrato || 'N/A'}</p>
                    <p class="text-gray-600 text-sm mb-1">Início Vigência: ${contract.inicioVigenciaTotal || 'N/A'}</p>
                    <p class="text-gray-600 text-sm mb-1">Término Atual: <span class="font-semibold">${contract.terminoAtualContrato || 'N/A'}</span></p>
                    <p class="text-gray-600 text-sm mb-1">Término Legal: <span class="font-semibold">${contract.terminoLegalVigencia || 'N/A'}</span></p>
                    <p class="text-gray-600 text-sm mb-1">Momento: ${contract.momentoAtual || 'N/A'}</p>
                    <p class="text-gray-600 text-sm mb-1">Tipo de Lei: ${contract.lawType || 'N/A'}</p>
                    <p class="text-gray-600 text-sm mb-1">Valor: R$ ${formatNumberFromFirebaseForDisplay(contract.valorContrato)}</p>
                    <p class="text-gray-600 text-sm mb-1">Unidades: ${contract.unidadesParticipantes && contract.unidadesParticipantes.length > 0 ? contract.unidadesParticipantes.join(', ') : 'N/A'}</p>
                    <p class="text-gray-600 text-sm mb-4">Movimentações: ${contract.ultimasMovimentacoes || 'N/A'}</p>
                    ${isAdmin ? `
                        <div class="flex flex-wrap gap-2 mt-4">
                            <button data-id="${contract.id}" class="edit-contract-btn bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-2 px-4 rounded-lg transition duration-200">
                                Editar
                            </button>
                            <button data-id="${contract.id}" class="renew-contract-btn bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-2 px-4 rounded-lg transition duration-200">
                                Renovar
                            </button>
                             <button data-id="${contract.id}" class="delete-contract-btn bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-2 px-4 rounded-lg transition duration-200">
                                Excluir
                            </button>
                        </div>
                    ` : ''}
                `;
                contractsGrid.appendChild(contractCard);
            });

            // Add event listeners for edit and delete buttons after rendering
            if (isAdmin) {
                document.querySelectorAll('.edit-contract-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const contractId = e.target.dataset.id;
                        editContract(contractId);
                    });
                });
                document.querySelectorAll('.renew-contract-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const contractId = e.target.dataset.id;
                        renewContract(contractId);
                    });
                });
                document.querySelectorAll('.delete-contract-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const contractId = e.target.dataset.id;
                        promptDeleteContract(contractId);
                    });
                });
            }
            updateGlobalAlerts(contracts, 'contract');
        }

        /**
         * Renders the list of reminders.
         * @param {Array<Object>} reminders - Array of reminder objects.
         */
        function renderReminders(reminders) {
            remindersList.innerHTML = ''; // Clear existing reminders

            if (reminders.length === 0) {
                remindersList.innerHTML = '<p class="text-center text-gray-600 text-lg mt-4">Nenhum lembrete adicionado ainda.</p>';
                return;
            }

            // Sort reminders by date (earliest first)
            const sortedReminders = [...reminders].sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateA - dateB;
            });

            sortedReminders.forEach(reminder => {
                const reminderItem = document.createElement('li');
                reminderItem.className = `flex items-center justify-between p-4 bg-gray-50 rounded-lg shadow-sm border border-gray-200 ${isReminderExpiringSoon(reminder.date) ? 'border-yellow-400 animate-pulse-red' : ''}`;

                let expiringSoonTag = '';
                if (isReminderExpiringSoon(reminder.date)) {
                    expiringSoonTag = `<span class="text-yellow-600 text-sm font-semibold ml-2"> (VENCENDO LOGO!)</span>`;
                }

                reminderItem.innerHTML = `
                    <p class="text-gray-800 font-medium">${reminder.text} - <span class="text-gray-500 text-sm">${formatDateFromInput(reminder.date)}</span>${expiringSoonTag}</p>
                    <button data-id="${reminder.id}" class="delete-reminder-btn text-red-500 hover:text-red-700 ml-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                remindersList.appendChild(reminderItem);
            });

            document.querySelectorAll('.delete-reminder-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const reminderId = e.target.closest('button').dataset.id;
                    deleteReminder(reminderId);
                });
            });
            updateGlobalAlerts(reminders, 'reminder');
        }

        /**
         * Checks if a reminder is expiring soon (within 7 days).
         * @param {string} reminderDateStr - The reminder date in YYYY-MM-DD.
         * @returns {boolean} True if expiring soon, false otherwise.
         */
        function isReminderExpiringSoon(reminderDateStr) {
            const reminderDate = new Date(reminderDateStr + 'T00:00:00'); // Ensure date is treated as UTC to avoid timezone issues
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time for accurate day comparison

            const diffTime = reminderDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays <= 7 && diffDays >= 0;
        }

        /**
         * Updates global alerts based on expiring contracts and reminders.
         * @param {Array<Object>} data - The data (contracts or reminders).
         * @param {string} type - 'contract' or 'reminder'.
         */
        function updateGlobalAlerts(data, type) {
            let expiringContractsCount = 0;
            let expiringRemindersCount = 0;

            if (type === 'contract') {
                expiringContractsCount = data.filter(isExpiringSoon).length;
            } else if (type === 'reminder') {
                expiringRemindersCount = data.filter(r => isReminderExpiringSoon(r.date)).length;
            }

            const totalExpiring = expiringContractsCount + expiringRemindersCount;
            // No direct element for global alert, so logging for now.
            // You can add a badge or notification area in the header if needed.
            console.log(`Alerts: ${expiringContractsCount} contracts, ${expiringRemindersCount} reminders expiring soon.`);
        }

        // --- Form Population Functions ---

        /**
         * Populates a select element with options.
         * @param {HTMLElement} selectElement - The select element.
         * @param {Array<string>} optionsArray - Array of option strings.
         */
        function populateSelect(selectElement, optionsArray) {
            selectElement.innerHTML = ''; // Clear existing options
            optionsArray.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
        }

        /**
         * Populates checkboxes for units.
         */
        function populateUnidadesCheckboxes() {
            unidadesCheckboxes.innerHTML = '';
            unidadesDisponiveis.forEach(unit => {
                const div = document.createElement('div');
                div.className = 'flex items-center mr-4';
                div.innerHTML = `
                    <input type="checkbox" id="unit-${unit}" value="${unit}" class="form-checkbox h-4 w-4 text-purple-600 rounded focus:ring-purple-500">
                    <label for="unit-${unit}" class="ml-2 text-gray-700 text-sm">${unit}</label>
                `;
                unidadesCheckboxes.appendChild(div);
            });
        }

        // --- Authentication Functions ---

        /**
         * Handles user login or registration.
         */
        async function handleAuthAction() {
            showLoading();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            const fullName = authFullNameInput.value;
            const cpf = authCpfInput.value;
            const phone = authPhoneInput.value;

            if (!email || !password) {
                displayAlert(["Por favor, insira email e palavra-passe."]);
                hideLoading();
                return;
            }

            try {
                if (isRegistering) {
                    // Registration
                    if (!fullName || !cpf || !phone) {
                        displayAlert(["Por favor, preencha todos os campos para registro: Nome Completo, CPF e Telefone."]);
                        hideLoading();
                        return;
                    }
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, "users", userCredential.user.uid), {
                        fullName: fullName,
                        cpf: cpf,
                        phone: phone,
                        email: email,
                        createdAt: Timestamp.now()
                    });
                    displayAlert(["Registo efetuado com sucesso! Agora pode fazer login."]);
                    // Optionally switch to login mode after successful registration
                    toggleAuthModeButton.click(); // Simulate click to switch to login
                } else {
                    // Login
                    await signInWithEmailAndPassword(auth, email, password);
                    displayAlert(["Sessão iniciada com sucesso!"]);
                }
            } catch (error) {
                console.error("Erro de autenticação:", error);
                let errorMessage = "Ocorreu um erro. Por favor, tente novamente.";
                if (error.code === 'auth/invalid-email') {
                    errorMessage = "Email inválido.";
                } else if (error.code === 'auth/user-disabled') {
                    errorMessage = "Utilizador desativado.";
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Email ou palavra-passe incorretos.";
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Este email já está registado.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Palavra-passe muito fraca (mínimo 6 caracteres).";
                }
                displayAlert([errorMessage]);
            } finally {
                hideLoading();
            }
        }

        /**
         * Toggles between login and registration mode on the auth screen.
         */
        function toggleAuthMode() {
            isRegistering = !isRegistering;
            if (isRegistering) {
                authTitle.textContent = "Registrar Nova Conta";
                authActionButton.textContent = "Registrar";
                toggleAuthModeButton.textContent = "Já tem uma conta? Faça Login";
                registerFieldsDiv.classList.remove('hidden');
            } else {
                authTitle.textContent = "Bem-vindo!";
                authActionButton.textContent = "Login";
                toggleAuthModeButton.textContent = "Não tem uma conta? Registe-se";
                registerFieldsDiv.classList.add('hidden');
            }
            // Clear inputs when toggling mode
            authEmailInput.value = '';
            authPasswordInput.value = '';
            authFullNameInput.value = '';
            authCpfInput.value = '';
            authPhoneInput.value = '';
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            showLoading();
            try {
                await signOut(auth);
                console.log("Utilizador desconectado.");
                displayAlert(["Sessão encerrada com sucesso!"]);
                setPage('list'); // Default to contracts list after logout (or you can show auth screen)
            } catch (error) {
                console.error("Erro ao desconectar:", error);
                displayAlert(["Erro ao encerrar sessão. Por favor, tente novamente."]);
            } finally {
                hideLoading();
            }
        }

        // --- Firebase Data Operations ---

        /**
         * Sets up real-time listeners for contracts and reminders.
         */
        function setupFirebaseListeners() {
            if (!db) {
                console.error("Firestore não está inicializado. Não é possível configurar listeners.");
                return;
            }
            // Contracts Listener (public)
            const contractsColRef = collection(db, "contracts");
            onSnapshot(contractsColRef, (snapshot) => {
                contractsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderContracts(contractsData);
                console.log("Contratos atualizados:", contractsData);
            }, (error) => {
                console.error("Erro ao obter contratos em tempo real:", error);
                displayAlert(["Erro ao carregar contratos. Verifique sua conexão ou permissões."]);
            });

            // Reminders Listener (private to user)
            if (userId) { // Only listen for reminders if user is logged in
                const remindersColRef = collection(db, `users/${userId}/reminders`);
                onSnapshot(remindersColRef, (snapshot) => {
                    remindersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderReminders(remindersData);
                    console.log("Lembretes atualizados:", remindersData);
                }, (error) => {
                    console.error("Erro ao obter lembretes em tempo real:", error);
                    displayAlert(["Erro ao carregar lembretes. Verifique sua conexão ou permissões."]);
                });
            } else {
                // Clear reminders if no user is logged in
                remindersData = [];
                renderReminders([]);
            }
        }


        /**
         * Adds or updates a contract in Firestore.
         */
        async function addUpdateContract() {
            showLoading();
            const contractId = addUpdateContractButton.dataset.editId;
            const isEditing = !!contractId;

            const processoSCEI = inputProcessoSCEI.value.trim();
            const nomeEmpresa = inputNomeEmpresa.value.trim();
            const objetoContratacao = inputObjetoContratacao.value.trim();
            const numeroContrato = inputNumeroContrato.value.trim();
            const inicioVigenciaTotal = inputInicioVigenciaTotal.value; // YYYY-MM-DD
            const momentoAtual = selectMomentoAtual.value;
            const terminoAtualContrato = inputTerminoAtualContrato.value; // YYYY-MM-DD
            const lawType = selectLawType.value;
            const valorContrato = parseValorContratoForSave(inputValorContrato.value);
            const ultimasMovimentacoes = inputUltimasMovimentacoes.value.trim();

            const selectedUnidades = Array.from(unidadesCheckboxes.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.value);

            // Basic validation
            if (!processoSCEI || !nomeEmpresa || !objetoContratacao || !numeroContrato ||
                !inicioVigenciaTotal || !momentoAtual || !terminoAtualContrato || !lawType ||
                valorContrato === null || selectedUnidades.length === 0) {
                displayAlert(["Por favor, preencha todos os campos obrigatórios para o contrato, incluindo pelo menos uma Unidade Participante."]);
                hideLoading();
                return;
            }

            const terminoLegalVigencia = calcularTerminoLegal(formatDateFromInput(inicioVigenciaTotal), lawType);
            if (terminoLegalVigencia.includes('inválid')) { // Check for error message from calculation
                displayAlert([`Erro na data de início da vigência ou tipo de lei: ${terminoLegalVigencia}.`]);
                hideLoading();
                return;
            }


            const contractData = {
                processoSCEI,
                nomeEmpresa,
                objetoContratacao,
                numeroContrato,
                inicioVigenciaTotal: formatDateFromInput(inicioVigenciaTotal),
                momentoAtual,
                terminoAtualContrato: formatDateFromInput(terminoAtualContrato),
                lawType,
                valorContrato,
                unidadesParticipantes: selectedUnidades,
                ultimasMovimentacoes,
                terminoLegalVigencia,
                lastUpdatedAt: Timestamp.now(),
                // Add createdAt only for new contracts
                ...(isEditing ? {} : { createdAt: Timestamp.now() }),
            };

            try {
                if (isEditing) {
                    await updateDoc(doc(db, "contracts", contractId), contractData);
                    displayAlert(["Contrato atualizado com sucesso!"]);
                } else {
                    await addDoc(collection(db, "contracts"), contractData);
                    displayAlert(["Contrato adicionado com sucesso!"]);
                }
                clearContractForm();
                setPage('list'); // Go back to contract list
            } catch (e) {
                console.error("Erro ao adicionar/atualizar documento: ", e);
                displayAlert(["Erro ao salvar contrato. Por favor, tente novamente."]);
            } finally {
                hideLoading();
            }
        }

        /**
         * Fills the contract form with data for editing.
         * @param {string} contractId - The ID of the contract to edit.
         */
        function editContract(contractId) {
            const contract = contractsData.find(c => c.id === contractId);
            if (!contract) {
                displayAlert(["Contrato não encontrado para edição."]);
                return;
            }

            registerContractTitle.textContent = "Editar Contrato";
            addUpdateContractButton.textContent = "Atualizar Contrato";
            addUpdateContractButton.dataset.editId = contractId; // Store ID for update
            cancelEditButton.classList.remove('hidden');

            inputProcessoSCEI.value = contract.processoSCEI || '';
            inputNomeEmpresa.value = contract.nomeEmpresa || '';
            inputObjetoContratacao.value = contract.objetoContratacao || '';
            inputNumeroContrato.value = contract.numeroContrato || '';
            inputInicioVigenciaTotal.value = formatDateForInput(contract.inicioVigenciaTotal || '');
            selectMomentoAtual.value = contract.momentoAtual || '';
            inputTerminoAtualContrato.value = formatDateForInput(contract.terminoAtualContrato || '');
            selectLawType.value = contract.lawType || '';
            inputValorContrato.value = formatNumberFromFirebaseForDisplay(contract.valorContrato);
            inputUltimasMovimentacoes.value = contract.ultimasMovimentacoes || '';

            // Set checkboxes for units
            unidadesDisponiveis.forEach(unit => {
                const checkbox = document.getElementById(`unit-${unit}`);
                if (checkbox) {
                    checkbox.checked = contract.unidadesParticipantes && contract.unidadesParticipantes.includes(unit);
                }
            });

            setPage('register');
        }

        /**
         * Clears the contract registration form.
         */
        function clearContractForm() {
            registerContractTitle.textContent = "Registrar Novo Contrato";
            addUpdateContractButton.textContent = "Adicionar Contrato";
            delete addUpdateContractButton.dataset.editId; // Remove stored ID
            cancelEditButton.classList.add('hidden');

            inputProcessoSCEI.value = '';
            inputNomeEmpresa.value = '';
            inputObjetoContratacao.value = '';
            inputNumeroContrato.value = '';
            inputInicioVigenciaTotal.value = '';
            selectMomentoAtual.value = momentoAtualOptions[0];
            inputTerminoAtualContrato.value = '';
            selectLawType.value = lawTypeOptions[0];
            inputValorContrato.value = '';
            inputUltimasMovimentacoes.value = '';

            // Uncheck all unit checkboxes
            unidadesCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        /**
         * Renews a contract by incrementing its 'momentoAtual' and extending 'terminoAtualContrato'.
         * @param {string} contractId - The ID of the contract to renew.
         */
        async function renewContract(contractId) {
            const contract = contractsData.find(c => c.id === contractId);
            if (!contract) {
                displayAlert(["Contrato não encontrado para renovação."]);
                return;
            }

            const currentIndex = momentoAtualOptions.indexOf(contract.momentoAtual);
            const currentTerminoDate = new Date(contract.terminoAtualContrato.split('/').reverse().join('-') + 'T00:00:00'); // YYYY-MM-DD format for Date object
            const inicioVigenciaDate = new Date(contract.inicioVigenciaTotal.split('/').reverse().join('-') + 'T00:00:00'); // YYYY-MM-DD format for Date object

            // Calculate max renewal period based on law type
            let maxMonths = 0;
            if (contract.lawType === 'Lei 8.666/93 (60 meses)') {
                maxMonths = 60; // 5 years from initial validity
            } else if (contract.lawType === 'Lei 14.133/21 (10 anos)') {
                maxMonths = 120; // 10 years from initial validity
            }

            const maxTerminoDate = new Date(inicioVigenciaDate);
            maxTerminoDate.setMonth(maxTerminoDate.getMonth() + maxMonths);
            // Adjust day if it overflows
            if (maxTerminoDate.getDate() !== inicioVigenciaDate.getDate()) {
                maxTerminoDate.setDate(0);
            }


            // Check if current contract end date has already reached or exceeded the maximum legal termination
            const today = new Date();
            today.setHours(0,0,0,0);

            if (currentTerminoDate >= maxTerminoDate) {
                 displayAlert([
                    `O contrato ${contract.numeroContrato} já atingiu ou excedeu seu prazo máximo de renovação legal (${formatDateFromInput(maxTerminoDate.toISOString().split('T')[0])}).`
                ]);
                return;
            }

            if (currentIndex === -1 || currentIndex >= momentoAtualOptions.length - 2) { // -2 to account for 'Não haverá renovação'
                displayAlert(["Este contrato não pode ser renovado mais ou atingiu o limite de renovações."]);
                return;
            }

            displayConfirm(`Tem certeza que deseja renovar o contrato ${contract.numeroContrato} para o próximo período?`, async () => {
                showLoading();
                try {
                    const nextMomento = momentoAtualOptions[currentIndex + 1];

                    // Determine the extension period based on the initial duration (5 or 10 years)
                    let monthsToExtend = 0;
                    if (contract.lawType === 'Lei 8.666/93 (60 meses)') {
                        monthsToExtend = 12; // Typically 1 year per renewal for 8.666/93
                    } else if (contract.lawType === 'Lei 14.133/21 (10 anos)') {
                        monthsToExtend = 12; // Assuming 1 year per renewal for 14.133/21 as well, adjust if different
                    }

                    const newTerminoDate = new Date(currentTerminoDate);
                    newTerminoDate.setMonth(newTerminoDate.getMonth() + monthsToExtend);

                    // Ensure new termination date does not exceed max legal termination
                    if (newTerminoDate > maxTerminoDate) {
                        newTerminoDate.setTime(maxTerminoDate.getTime()); // Set to max legal date
                    }

                    const formattedNewTermino = `${String(newTerminoDate.getDate()).padStart(2, '0')}/${String(newTerminoDate.getMonth() + 1).padStart(2, '0')}/${newTerminoDate.getFullYear()}`;

                    const updatedData = {
                        momentoAtual: nextMomento,
                        terminoAtualContrato: formattedNewTermino,
                        ultimasMovimentacoes: (contract.ultimasMovimentacoes || '') + `\nRenovado para ${nextMomento} até ${formattedNewTermino} em ${formatDateFromInput(new Date().toISOString().split('T')[0])}.`,
                        lastUpdatedAt: Timestamp.now()
                    };

                    await updateDoc(doc(db, "contracts", contractId), updatedData);
                    displayAlert(["Contrato renovado com sucesso!"]);
                } catch (e) {
                    console.error("Erro ao renovar contrato: ", e);
                    displayAlert(["Erro ao renovar contrato. Por favor, tente novamente."]);
                } finally {
                    hideLoading();
                }
            });
        }

        /**
         * Prompts the user to confirm contract deletion and provide a reason.
         * @param {string} contractId - The ID of the contract to delete.
         */
        function promptDeleteContract(contractId) {
            displayConfirm(`Tem certeza que deseja EXCLUIR este contrato? Esta ação é irreversível. Por favor, forneça o motivo da exclusão:
            <br><input type="text" id="delete-reason-input" class="w-full mt-4 px-3 py-2 border border-gray-300 rounded-lg" placeholder="Motivo da exclusão" />`,
            async () => {
                const reasonInput = document.getElementById('delete-reason-input');
                const reason = reasonInput ? reasonInput.value.trim() : '';
                if (!reason) {
                    displayAlert(["É obrigatório fornecer um motivo para a exclusão do contrato."]);
                    return;
                }
                deleteContract(contractId, reason);
            });
        }


        /**
         * Deletes a contract from Firestore.
         * @param {string} contractId - The ID of the contract to delete.
         * @param {string} reason - The reason for deletion.
         */
        async function deleteContract(contractId, reason) {
            showLoading();
            try {
                // Fetch the contract before deleting to move it to a 'deleted' collection
                const contractRef = doc(db, "contracts", contractId);
                const contractSnap = await getDoc(contractRef);
                if (contractSnap.exists()) {
                    const contractData = contractSnap.data();
                    // Add to 'deleted_contracts' collection
                    await addDoc(collection(db, "deleted_contracts"), {
                        ...contractData,
                        deletedAt: Timestamp.now(),
                        deletedBy: userEmail, // Or userId
                        deletionReason: reason
                    });
                    // Now delete from 'contracts' collection
                    await deleteDoc(contractRef);
                    displayAlert(["Contrato excluído e movido para registros de exclusão com sucesso!"]);
                } else {
                    displayAlert(["Contrato não encontrado para exclusão."]);
                }
            } catch (e) {
                console.error("Erro ao excluir contrato: ", e);
                displayAlert(["Erro ao excluir contrato. Por favor, tente novamente."]);
            } finally {
                hideLoading();
            }
        }


        /**
         * Adds a new reminder to Firestore for the current user.
         */
        async function addReminder() {
            showLoading();
            const reminderText = inputReminderText.value.trim();
            const reminderDate = inputReminderDate.value; // YYYY-MM-DD

            if (!reminderText || !reminderDate) {
                displayAlert(["Por favor, insira o texto e a data do lembrete."]);
                hideLoading();
                return;
            }

            if (!userId) {
                displayAlert(["Erro: Não foi possível adicionar lembrete. O utilizador não está autenticado."]);
                hideLoading();
                return;
            }

            try {
                await addDoc(collection(db, `users/${userId}/reminders`), {
                    text: reminderText,
                    date: reminderDate, // Store as YYYY-MM-DD string for easier sorting/comparison
                    createdAt: Timestamp.now()
                });
                displayAlert(["Lembrete adicionado com sucesso!"]);
                inputReminderText.value = '';
                inputReminderDate.value = '';
            } catch (e) {
                console.error("Erro ao adicionar lembrete: ", e);
                displayAlert(["Erro ao adicionar lembrete. Por favor, tente novamente."]);
            } finally {
                hideLoading();
            }
        }

        /**
         * Deletes a reminder from Firestore for the current user.
         * @param {string} reminderId - The ID of the reminder to delete.
         */
        async function deleteReminder(reminderId) {
            displayConfirm("Tem certeza que deseja excluir este lembrete?", async () => {
                showLoading();
                if (!userId) {
                    displayAlert(["Erro: Não foi possível excluir lembrete. O utilizador não está autenticado."]);
                    hideLoading();
                    return;
                }
                try {
                    await deleteDoc(doc(db, `users/${userId}/reminders`, reminderId));
                    displayAlert(["Lembrete excluído com sucesso!"]);
                } catch (e) {
                    console.error("Erro ao excluir lembrete: ", e);
                    displayAlert(["Erro ao excluir lembrete. Por favor, tente novamente."]);
                } finally {
                    hideLoading();
                }
            });
        }

        // --- Event Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            // Populate select options and checkboxes on load
            populateSelect(selectMomentoAtual, momentoAtualOptions);
            populateSelect(selectLawType, lawTypeOptions);
            populateUnidadesCheckboxes();

            // Set current date for date inputs
            const today = new Date().toISOString().split('T')[0];
            inputInicioVigenciaTotal.value = today;
            inputTerminoAtualContrato.value = today;
            inputReminderDate.value = today;

            // Auth Screen Listeners
            authActionButton.addEventListener('click', handleAuthAction);
            toggleAuthModeButton.addEventListener('click', toggleAuthMode);
            authEmailInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleAuthAction();
            });
            authPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleAuthAction();
            });


            // Main App Navigation
            navListButton.addEventListener('click', () => setPage('list'));
            navRegisterButton.addEventListener('click', () => {
                clearContractForm(); // Ensure form is clear when navigating to register
                setPage('register');
            });
            navRemindersButton.addEventListener('click', () => setPage('reminders'));
            logoutButton.addEventListener('click', handleLogout);

            // Contract Form Listeners
            inputValorContrato.addEventListener('input', handleValorContratoInputChange);
            addUpdateContractButton.addEventListener('click', addUpdateContract);
            cancelEditButton.addEventListener('click', clearContractForm);

            // Reminder Form Listeners
            addReminderButton.addEventListener('click', addReminder);

            // Custom Modal Listeners
            alertCloseButton.addEventListener('click', hideAlert);
            confirmActionButton.addEventListener('click', handleConfirm);
            confirmCancelButton.addEventListener('click', handleCancelConfirm);

            // Firebase Auth State Listener
            // This listener determines if a user is logged in or out
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    isLoggedIn = true;
                    userId = user.uid;
                    userEmail = user.email;
                    // Check if user.uid is in the ADMIN_UIDs array
                    isAdmin = ADMIN_UIDs.includes(user.uid);

                    userEmailDisplay.textContent = userEmail;
                    userRoleDisplay.textContent = isAdmin ? 'Administrador' : 'Visualizador';
                    userIdDisplay.textContent = userId;

                    authScreen.classList.add('hidden');
                    mainAppContent.classList.remove('hidden');
                    setPage('list'); // Default to contracts list after login
                    setupFirebaseListeners(); // Start listening for data
                } else {
                    isLoggedIn = false;
                    userId = '';
                    userEmail = '';
                    isAdmin = false;
                    authScreen.classList.remove('hidden');
                    mainAppContent.classList.add('hidden');
                    // Clear any existing data if user logs out
                    contractsData = [];
                    remindersData = [];
                    renderContracts([]);
                    renderReminders([]);
                    updateGlobalAlerts([], 'contract');
                    updateGlobalAlerts([], 'reminder');
                }
                hideLoading();
            });
        });
    </script>
</body>
</html>
