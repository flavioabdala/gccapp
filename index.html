<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Contratos Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Bibliotecas para Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .login-background { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .status-badge { padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .status-renewal { background-color: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="app" class="flex-grow flex items-center justify-center p-4 login-background">
        <!-- Tela de Login -->
        <div id="login-section" class="w-full max-w-md bg-white rounded-xl shadow-2xl p-8">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Contratos Admin</h1>
            <div id="auth-ui" class="space-y-4">
                <button id="btn-login-anon" class="w-full py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition">Acessar Sistema</button>
                <p class="text-xs text-center text-gray-500">Autenticação segura via Firebase</p>
            </div>
        </div>

        <!-- Dashboard Principal (Oculto inicialmente) -->
        <div id="main-dashboard" class="hidden w-full max-w-7xl h-[90vh] bg-gray-50 rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-indigo-800 text-white p-6 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold">Painel de Gestão</h2>
                    <p class="text-indigo-200 text-sm" id="user-info">Carregando...</p>
                </div>
                <div class="flex gap-3">
                    <button id="btn-export-excel" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                        <i class="fas fa-file-excel"></i> Exportar XLSX
                    </button>
                    <button id="btn-logout" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg text-sm font-bold">Sair</button>
                </div>
            </header>

            <!-- Menu de Tabs -->
            <nav class="bg-white border-b flex px-6 space-x-6">
                <button class="tab-trigger py-4 border-b-2 border-indigo-600 text-indigo-600 font-bold" data-target="tab-ativos">Ativos</button>
                <button class="tab-trigger py-4 border-b-2 border-transparent text-gray-500 hover:text-indigo-600" data-target="tab-vencendo">Vencendo (180 dias)</button>
                <button class="tab-trigger py-4 border-b-2 border-transparent text-gray-500 hover:text-indigo-600" data-target="tab-encerrados">Encerrados</button>
            </nav>

            <!-- Conteúdo das Tabs -->
            <main class="flex-grow overflow-y-auto p-6">
                <div id="tab-ativos" class="tab-content active">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-700">Contratos Vigentes</h3>
                        <button id="btn-new-contract" class="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-indigo-700">+ Novo Contrato</button>
                    </div>
                    <div id="list-ativos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>

                <div id="tab-vencendo" class="tab-content">
                    <h3 class="text-xl font-bold text-gray-700 mb-6">Alerta de Renovação</h3>
                    <div id="list-vencendo" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>

                <div id="tab-encerrados" class="tab-content">
                    <h3 class="text-xl font-bold text-gray-700 mb-6">Histórico de Encerrados</h3>
                    <div id="list-encerrados" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Form Contrato -->
    <div id="modal-contract" class="modal">
        <div class="bg-white w-full max-w-4xl p-8 rounded-2xl shadow-2xl relative overflow-y-auto max-h-[90vh]">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('modal-contract')"><i class="fas fa-times fa-lg"></i></button>
            <h2 class="text-2xl font-bold mb-6" id="modal-title">Cadastrar Contrato</h2>
            
            <form id="form-contract" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="hidden" id="field-id">
                <div class="md:col-span-1">
                    <label class="block text-xs font-bold text-gray-500 uppercase">Número SEI</label>
                    <input type="text" id="field-sei" required class="w-full p-2 border rounded mt-1">
                </div>
                <div class="md:col-span-1">
                    <label class="block text-xs font-bold text-gray-500 uppercase">Nº Contrato</label>
                    <input type="text" id="field-numero" required class="w-full p-2 border rounded mt-1">
                </div>
                <div class="md:col-span-1">
                    <label class="block text-xs font-bold text-gray-500 uppercase">Valor Atual (R$)</label>
                    <input type="text" id="field-valor" placeholder="0,00" required class="w-full p-2 border rounded mt-1">
                </div>
                <div class="md:col-span-3">
                    <label class="block text-xs font-bold text-gray-500 uppercase">Empresa / Contratada</label>
                    <input type="text" id="field-empresa" required class="w-full p-2 border rounded mt-1">
                </div>
                <div class="md:col-span-3">
                    <label class="block text-xs font-bold text-gray-500 uppercase">Objeto</label>
                    <textarea id="field-objeto" rows="2" required class="w-full p-2 border rounded mt-1"></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Vigência Inicial</label>
                    <input type="date" id="field-data-inicio" required class="w-full p-2 border rounded mt-1">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Vigência Atual</label>
                    <input type="date" id="field-data-fim" required class="w-full p-2 border rounded mt-1">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Lei Aplicada</label>
                    <select id="field-lei" class="w-full p-2 border rounded mt-1">
                        <option value="8666">Lei 8.666/93</option>
                        <option value="14133">Lei 14.133/21</option>
                    </select>
                </div>

                <div class="md:col-span-3 border-t pt-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Unidades Participantes (Separadas por vírgula)</label>
                    <input type="text" id="field-unidades" placeholder="Ex: Financeiro, TI, RH" class="w-full p-2 border rounded">
                </div>

                <div class="md:col-span-3 flex items-center gap-2 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                    <input type="checkbox" id="field-renovacao-iniciada" class="w-5 h-5">
                    <label for="field-renovacao-iniciada" class="text-sm font-bold text-yellow-800">Processo de Renovação já foi iniciado?</label>
                </div>

                <div class="md:col-span-3 flex justify-end gap-3 pt-6">
                    <button type="button" onclick="closeModal('modal-contract')" class="px-6 py-2 bg-gray-200 rounded-lg font-bold">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold">Salvar Contrato</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Aditivos / Apostilamentos -->
    <div id="modal-event" class="modal">
        <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-2xl relative">
            <h2 class="text-xl font-bold mb-4">Adicionar Evento ao Histórico</h2>
            <form id="form-event" class="space-y-4">
                <input type="hidden" id="event-contract-id">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Tipo</label>
                    <select id="event-type" class="w-full p-2 border rounded">
                        <option value="Aditivo">Termo Aditivo</option>
                        <option value="Apostilamento">Apostilamento</option>
                        <option value="Reajuste">Reajuste de Valor</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Descrição/Resumo</label>
                    <input type="text" id="event-desc" required placeholder="Ex: Prorrogação por 12 meses" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Data do Evento</label>
                    <input type="date" id="event-date" required class="w-full p-2 border rounded">
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeModal('modal-event')" class="px-4 py-2 bg-gray-200 rounded">Voltar</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded">Registrar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração segura do ambiente
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'contratos-default';

        let currentUser = null;
        let allContracts = [];

        // --- AUTH ---
        document.getElementById('btn-login-anon').onclick = async () => {
            try {
                await signInAnonymously(auth);
            } catch (e) {
                console.error(e);
                alert("Erro ao conectar ao banco de dados.");
            }
        };

        document.getElementById('btn-logout').onclick = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('main-dashboard').classList.remove('hidden');
                document.getElementById('user-info').innerText = `Logado como: ${user.uid}`;
                initDataListener();
            } else {
                currentUser = null;
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('main-dashboard').classList.add('hidden');
            }
        });

        // --- DATA LISTENER ---
        function initDataListener() {
            // Regra 1 e 2: Path restrito conforme instruções
            const colPath = collection(db, 'artifacts', appId, 'public', 'data', 'contracts');
            
            onSnapshot(colPath, (snapshot) => {
                allContracts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAll();
            }, (error) => console.error("Erro no Firestore:", error));
        }

        // --- RENDERING ---
        function renderAll() {
            const today = new Date();
            const threshold = new Date();
            threshold.setDate(today.getDate() + 180);

            const ativos = [];
            const vencendo = [];
            const encerrados = [];

            allContracts.forEach(c => {
                const dateFim = new Date(c.dataFim);
                
                // Regra 5: Migração imediata para encerrados se vencido
                if (dateFim < today) {
                    encerrados.push(c);
                } else if (dateFim <= threshold) {
                    vencendo.push(c);
                    ativos.push(c); // Aparece em ambos para visibilidade
                } else {
                    ativos.push(c);
                }
            });

            renderList(document.getElementById('list-ativos'), ativos);
            renderList(document.getElementById('list-vencendo'), vencendo);
            renderList(document.getElementById('list-encerrados'), encerrados, true);
        }

        function renderList(container, list, isHistory = false) {
            container.innerHTML = '';
            if (list.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-10 text-gray-400">Nenhum contrato nesta categoria.</div>`;
                return;
            }

            list.forEach(c => {
                const card = document.createElement('div');
                card.className = `bg-white p-5 rounded-xl shadow border-l-4 ${isHistory ? 'border-gray-400 opacity-75' : 'border-indigo-500'} relative`;
                
                // Regra 3: Badge de renovação iniciada
                const renewalBadge = c.renovacaoIniciada 
                    ? `<span class="status-badge status-renewal absolute top-4 right-4"><i class="fas fa-sync fa-spin mr-1"></i> RENOVAÇÃO INICIADA</span>`
                    : '';

                card.innerHTML = `
                    ${renewalBadge}
                    <div class="mb-3">
                        <h4 class="font-bold text-lg text-gray-800">${c.empresa}</h4>
                        <p class="text-xs text-gray-500">Contrato: ${c.numero} | SEI: ${c.sei}</p>
                    </div>
                    <div class="text-sm text-gray-600 mb-4 line-clamp-2">
                        <strong>Objeto:</strong> ${c.objeto}
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-xs mb-4">
                        <div class="bg-gray-50 p-2 rounded">
                            <p class="text-gray-400 uppercase font-bold">Vencimento</p>
                            <p class="text-gray-800 font-bold">${formatDate(c.dataFim)}</p>
                        </div>
                        <div class="bg-gray-50 p-2 rounded">
                            <p class="text-gray-400 uppercase font-bold">Valor Atual</p>
                            <p class="text-indigo-600 font-bold">R$ ${c.valor || '0,00'}</p>
                        </div>
                    </div>
                    <div class="mb-4">
                        <p class="text-[10px] text-gray-400 uppercase font-bold">Unidades</p>
                        <div class="flex flex-wrap gap-1 mt-1">
                            ${(c.unidades || '').split(',').map(u => u.trim()).filter(u => u).map(u => `<span class="px-2 py-1 bg-indigo-50 text-indigo-700 rounded text-[10px]">${u}</span>`).join('')}
                        </div>
                    </div>
                    
                    <div class="border-t pt-3 flex justify-between">
                         <div class="flex gap-2">
                            <button onclick="editContract('${c.id}')" class="text-indigo-600 hover:text-indigo-800 text-xs font-bold uppercase">Editar</button>
                            <button onclick="openEventModal('${c.id}')" class="text-purple-600 hover:text-purple-800 text-xs font-bold uppercase">Eventos</button>
                         </div>
                         <button onclick="viewHistory('${c.id}')" class="text-gray-500 hover:text-gray-700 text-xs"><i class="fas fa-history"></i></button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- FORM HANDLERS ---
        document.getElementById('btn-new-contract').onclick = () => {
            document.getElementById('form-contract').reset();
            document.getElementById('field-id').value = '';
            document.getElementById('modal-title').innerText = 'Novo Contrato';
            openModal('modal-contract');
        };

        document.getElementById('form-contract').onsubmit = async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const id = document.getElementById('field-id').value || crypto.randomUUID();
            
            // Regra 1 e 2: Garantindo captura correta de valor e unidades
            const contractData = {
                sei: document.getElementById('field-sei').value,
                numero: document.getElementById('field-numero').value,
                valor: document.getElementById('field-valor').value,
                empresa: document.getElementById('field-empresa').value,
                objeto: document.getElementById('field-objeto').value,
                dataInicio: document.getElementById('field-data-inicio').value,
                dataFim: document.getElementById('field-data-fim').value,
                lei: document.getElementById('field-lei').value,
                unidades: document.getElementById('field-unidades').value,
                renovacaoIniciada: document.getElementById('field-renovacao-iniciada').checked,
                updatedAt: new Date().toISOString()
            };

            // Se for novo, inicializa histórico
            if (!document.getElementById('field-id').value) {
                contractData.historico = [{
                    tipo: 'Criação',
                    desc: 'Contrato cadastrado no sistema',
                    data: new Date().toISOString().split('T')[0]
                }];
            }

            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'contracts', id);
                await setDoc(docRef, contractData, { merge: true });
                closeModal('modal-contract');
            } catch (err) {
                console.error(err);
                alert("Erro ao salvar dados.");
            }
        };

        // Regra 4: Inclusão de aditivos reflete no histórico
        document.getElementById('form-event').onsubmit = async (e) => {
            e.preventDefault();
            const cid = document.getElementById('event-contract-id').value;
            const contract = allContracts.find(c => c.id === cid);
            if (!contract) return;

            const newEvent = {
                tipo: document.getElementById('event-type').value,
                desc: document.getElementById('event-desc').value,
                data: document.getElementById('event-date').value
            };

            const updatedHistory = [...(contract.historico || []), newEvent];

            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'contracts', cid);
                await updateDoc(docRef, { historico: updatedHistory });
                closeModal('modal-event');
            } catch (err) {
                console.error(err);
            }
        };

        // --- EXCEL EXPORT (Regra 6) ---
        document.getElementById('btn-export-excel').onclick = () => {
            if (allContracts.length === 0) return alert("Não há dados para exportar.");

            const dataToExport = allContracts.map(c => ({
                'Processo SEI': c.sei,
                'Nº Contrato': c.numero,
                'Empresa': c.empresa,
                'Valor Atual': c.valor,
                'Vigência Inicial': c.dataInicio,
                'Vigência Final': c.dataFim,
                'Objeto': c.objeto,
                'Unidades': c.unidades,
                'Renovação Iniciada': c.renovacaoIniciada ? 'Sim' : 'Não',
                'Lei': c.lei
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Contratos");
            XLSX.writeFile(workbook, `Relatorio_Contratos_${new Date().toISOString().split('T')[0]}.xlsx`);
        };

        // --- HELPERS ---
        window.editContract = (id) => {
            const c = allContracts.find(item => item.id === id);
            if (!c) return;
            document.getElementById('field-id').value = c.id;
            document.getElementById('field-sei').value = c.sei;
            document.getElementById('field-numero').value = c.numero;
            document.getElementById('field-valor').value = c.valor || '';
            document.getElementById('field-empresa').value = c.empresa;
            document.getElementById('field-objeto').value = c.objeto;
            document.getElementById('field-data-inicio').value = c.dataInicio;
            document.getElementById('field-data-fim').value = c.dataFim;
            document.getElementById('field-lei').value = c.lei;
            document.getElementById('field-unidades').value = c.unidades || '';
            document.getElementById('field-renovacao-iniciada').checked = !!c.renovacaoIniciada;
            
            document.getElementById('modal-title').innerText = 'Editar Contrato';
            openModal('modal-contract');
        };

        window.openEventModal = (id) => {
            document.getElementById('event-contract-id').value = id;
            document.getElementById('form-event').reset();
            openModal('modal-event');
        };

        window.viewHistory = (id) => {
            const c = allContracts.find(item => item.id === id);
            if (!c || !c.historico) return;
            const historyText = c.historico.map(h => `[${formatDate(h.data)}] ${h.tipo}: ${h.desc}`).join('\n');
            alert(`Histórico do Contrato ${c.numero}:\n\n${historyText}`);
        };

        window.openModal = (id) => document.getElementById(id).classList.add('active');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');

        function formatDate(d) {
            if (!d) return '-';
            const parts = d.split('-');
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }

        // Tab system
        document.querySelectorAll('.tab-trigger').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.tab-trigger').forEach(b => b.classList.remove('border-indigo-600', 'text-indigo-600'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('border-indigo-600', 'text-indigo-600');
                document.getElementById(btn.dataset.target).classList.add('active');
            };
        });

    </script>
</body>
</html>
