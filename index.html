<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Contratos e Lembretes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para a fonte Inter */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }

        /* Animação de piscar para contratos vencendo */
        @keyframes pulse-red {
            0%, 100% { border-color: #ef4444; } /* red-500 */
            50% { border-color: #f87171; } /* red-400 */
        }
        .animate-pulse-red {
            animation: pulse-red 1.5s infinite;
        }

        /* Estilos para o modal de alerta e confirmação */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 90%;
            width: 400px;
        }

        .modal-buttons {
            margin-top: 1.5rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .hidden {
            display: none !important;
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-[1001] hidden">
        <div class="loading-spinner"></div>
    </div>

    <div id="customAlertModal" class="modal-overlay hidden">
        <div class="modal-content">
            <p id="customAlertMessage" class="text-gray-700 text-lg"></p>
            <div class="modal-buttons">
                <button id="customAlertOkButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">OK</button>
            </div>
        </div>
    </div>

    <div id="customConfirmModal" class="modal-overlay hidden">
        <div class="modal-content">
            <p id="customConfirmMessage" class="text-gray-700 text-lg"></p>
            <div class="modal-buttons">
                <button id="customConfirmCancelButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Cancelar</button>
                <button id="customConfirmOkButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">OK</button>
            </div>
        </div>
    </div>

    <div id="auth-screen" class="flex-grow flex items-center justify-center bg-gray-50 p-4">
        <div class="w-full max-w-md bg-white rounded-lg shadow-md p-6">
            <h2 id="auth-mode-title" class="text-2xl font-bold text-center mb-6 text-gray-800">Login</h2>
            <div class="mb-4">
                <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="seuemail@exemplo.com">
            </div>
            <div class="mb-6">
                <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Senha:</label>
                <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" placeholder="********">
            </div>
            <div class="flex items-center justify-between">
                <button id="auth-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">Entrar</button>
            </div>
            <p class="text-center text-gray-600 text-sm mt-4">
                <button id="toggle-auth-mode" class="text-blue-500 hover:text-blue-800">Criar uma conta</button>
            </p>
        </div>
    </div>

    <div id="main-app-content" class="flex-grow flex flex-col hidden">
        <header class="bg-gray-800 text-white p-4 shadow-md flex justify-between items-center flex-wrap gap-2">
            <div class="flex items-center">
                <h1 class="text-2xl font-bold mr-4">Gestão de Contratos e Lembretes</h1>
                <nav>
                    <button id="contracts-nav-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-2">Contratos</button>
                    <button id="reminders-nav-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Lembretes</button>
                </nav>
            </div>
            <div class="text-right flex items-center flex-wrap gap-2">
                <span class="text-sm font-semibold hidden md:inline" id="user-email-display"></span>
                <span class="text-sm text-gray-400 hidden md:inline" id="user-role-display"></span>
                <span class="text-xs text-gray-500 hidden" id="user-id-display"></span>
                <button id="logout-button" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm ml-2">Sair</button>
            </div>
        </header>

        <div id="global-alerts" class="p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 hidden" role="alert">
            <p class="font-bold">Avisos Importantes:</p>
            <ul id="global-alert-list" class="mt-2 list-disc list-inside"></ul>
        </div>

        <main id="contracts-section" class="flex-grow p-6 bg-gray-50 hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Adicionar/Editar Contrato</h2>
                <form id="contract-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="contract-client" class="block text-gray-700 text-sm font-bold mb-2">Cliente:</label>
                        <input type="text" id="contract-client" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Nome do Cliente" required>
                    </div>
                    <div>
                        <label for="contract-type" class="block text-gray-700 text-sm font-bold mb-2">Tipo de Contrato:</label>
                        <input type="text" id="contract-type" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Ex: Manutenção, Serviço, Locação" required>
                    </div>
                    <div>
                        <label for="contract-start-date" class="block text-gray-700 text-sm font-bold mb-2">Data de Início:</label>
                        <input type="date" id="contract-start-date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div>
                        <label for="contract-end-date" class="block text-gray-700 text-sm font-bold mb-2">Data de Término:</label>
                        <input type="date" id="contract-end-date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="contract-value" class="block text-gray-700 text-sm font-bold mb-2">Valor (R$):</label>
                        <input type="number" id="contract-value" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="contract-notes" class="block text-gray-700 text-sm font-bold mb-2">Observações:</label>
                        <textarea id="contract-notes" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Detalhes adicionais..."></textarea>
                    </div>
                    <div class="md:col-span-2 flex justify-end">
                        <button type="submit" id="contract-submit-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Adicionar Contrato</button>
                        <button type="button" id="contract-cancel-edit-btn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline ml-2 hidden">Cancelar Edição</button>
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Contratos Existentes</h2>
                <div class="mb-4 flex flex-wrap gap-2 justify-between items-center">
                    <input type="text" id="contracts-search" placeholder="Pesquisar contratos..." class="shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline flex-grow">
                    <select id="contracts-sort" class="shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="endDateAsc">Data de Término (Crescente)</option>
                        <option value="endDateDesc">Data de Término (Decrescente)</option>
                        <option value="clientAsc">Cliente (A-Z)</option>
                        <option value="clientDesc">Cliente (Z-A)</option>
                    </select>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead>
                            <tr class="w-full bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Cliente</th>
                                <th class="py-3 px-6 text-left">Tipo</th>
                                <th class="py-3 px-6 text-left">Início</th>
                                <th class="py-3 px-6 text-left">Término</th>
                                <th class="py-3 px-6 text-left">Valor</th>
                                <th class="py-3 px-6 text-left">Observações</th>
                                <th class="py-3 px-6 text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="contracts-table-body" class="text-gray-600 text-sm font-light">
                            </tbody>
                    </table>
                    <p id="no-contracts-message" class="text-center text-gray-500 mt-4 hidden">Nenhum contrato encontrado.</p>
                </div>
            </div>
        </main>

        <main id="reminders-section" class="flex-grow p-6 bg-gray-50 hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Adicionar/Editar Lembrete</h2>
                <form id="reminder-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="reminder-title" class="block text-gray-700 text-sm font-bold mb-2">Título:</label>
                        <input type="text" id="reminder-title" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Título do Lembrete" required>
                    </div>
                    <div>
                        <label for="reminder-date" class="block text-gray-700 text-sm font-bold mb-2">Data:</label>
                        <input type="date" id="reminder-date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="reminder-notes" class="block text-gray-700 text-sm font-bold mb-2">Observações:</label>
                        <textarea id="reminder-notes" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Detalhes do lembrete..."></textarea>
                    </div>
                    <div class="md:col-span-2 flex justify-end">
                        <button type="submit" id="reminder-submit-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Adicionar Lembrete</button>
                        <button type="button" id="reminder-cancel-edit-btn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline ml-2 hidden">Cancelar Edição</button>
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Lembretes Existentes</h2>
                <div class="mb-4 flex flex-wrap gap-2 justify-between items-center">
                    <input type="text" id="reminders-search" placeholder="Pesquisar lembretes..." class="shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline flex-grow">
                    <select id="reminders-sort" class="shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="dateAsc">Data (Crescente)</option>
                        <option value="dateDesc">Data (Decrescente)</option>
                        <option value="titleAsc">Título (A-Z)</option>
                        <option value="titleDesc">Título (Z-A)</option>
                    </select>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead>
                            <tr class="w-full bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Título</th>
                                <th class="py-3 px-6 text-left">Data</th>
                                <th class="py-3 px-6 text-left">Observações</th>
                                <th class="py-3 px-6 text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="reminders-table-body" class="text-gray-600 text-sm font-light">
                            </tbody>
                    </table>
                    <p id="no-reminders-message" class="text-center text-gray-500 mt-4 hidden">Nenhum lembrete encontrado.</p>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // Firebase Configuration (coloque suas credenciais AQUI)
const firebaseConfig = {
  apiKey: "AIzaSyDTxRQdMy4QugmySVeSErf5Kqihn_4OhWw",
  authDomain: "gcc-contratos.firebaseapp.com",
  projectId: "gcc-contratos",
  storageBucket: "gcc-contratos.firebasestorage.app",
  messagingSenderId: "405415511927",
  appId: "1:405415511927:web:4612190119302726820372",
  measurementId: "G-T1T4N9WD5T"
};

        // Inicialize o Firebase
        let app;
        let auth;
        let db;
        let contractsCollection;
        let remindersCollection;

        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            contractsCollection = db.collection('contracts');
            remindersCollection = db.collection('reminders');
        } catch (error) {
            console.error("Erro ao inicializar Firebase:", error);
            // === LINHA MODIFICADA: REMOVIDA A EXIBIÇÃO INICIAL DO ALERTA DE ERRO DO BANCO DE DADOS ===
            // displayAlert(["Erro: O sistema de base de dados não foi inicializado. Por favor, forneça suas credenciais Firebase e recarregue a página."]);
        }

        // === LINHA MODIFICADA: REMOVIDA A EXIBIÇÃO INICIAL DO ALERTA DE CREDENCIAIS ===
        // if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
        //     displayAlert(["Aviso: As credenciais do Firebase não foram configuradas. O aplicativo não funcionará corretamente. Por favor, edite o código para adicionar suas credenciais."]);
        // }

        // Variáveis globais
        let isLoggedIn = false;
        let userId = '';
        let userEmail = '';
        let isAdmin = false;
        const ADMIN_UID = 'SEU_UID_DE_ADMIN_AQUI'; // Substitua pelo UID do usuário administrador, se houver

        let contractsData = [];
        let remindersData = [];
        let currentEditingContractId = null;
        let currentEditingReminderId = null;
        let contractsUnsubscribe = null;
        let remindersUnsubscribe = null;

        // Elementos DOM
        const loadingOverlay = document.getElementById('loading-overlay');
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertOkButton = document.getElementById('customAlertOkButton');
        const customConfirmModal = document.getElementById('customConfirmModal');
        const customConfirmMessage = document.getElementById('customConfirmMessage');
        const customConfirmOkButton = document.getElementById('customConfirmOkButton');
        const customConfirmCancelButton = document.getElementById('customConfirmCancelButton');

        const authScreen = document.getElementById('auth-screen');
        const mainAppContent = document.getElementById('main-app-content');
        const authModeTitle = document.getElementById('auth-mode-title');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authButton = document.getElementById('auth-button');
        const toggleAuthModeButton = document.getElementById('toggle-auth-mode');
        const logoutButton = document.getElementById('logout-button');

        const userEmailDisplay = document.getElementById('user-email-display');
        const userRoleDisplay = document.getElementById('user-role-display');
        const userIdDisplay = document.getElementById('user-id-display');
        const contractsNavBtn = document.getElementById('contracts-nav-btn');
        const remindersNavBtn = document.getElementById('reminders-nav-btn');
        const contractsSection = document.getElementById('contracts-section');
        const remindersSection = document.getElementById('reminders-section');
        const globalAlerts = document.getElementById('global-alerts');
        const globalAlertList = document.getElementById('global-alert-list');

        // Contract Elements
        const contractForm = document.getElementById('contract-form');
        const contractClientInput = document.getElementById('contract-client');
        const contractTypeInput = document.getElementById('contract-type');
        const contractStartDateInput = document.getElementById('contract-start-date');
        const contractEndDateInput = document.getElementById('contract-end-date');
        const contractValueInput = document.getElementById('contract-value');
        const contractNotesInput = document.getElementById('contract-notes');
        const contractSubmitBtn = document.getElementById('contract-submit-btn');
        const contractCancelEditBtn = document.getElementById('contract-cancel-edit-btn');
        const contractsTableBody = document.getElementById('contracts-table-body');
        const contractsSearchInput = document.getElementById('contracts-search');
        const contractsSortSelect = document.getElementById('contracts-sort');
        const noContractsMessage = document.getElementById('no-contracts-message');

        // Reminder Elements
        const reminderForm = document.getElementById('reminder-form');
        const reminderTitleInput = document.getElementById('reminder-title');
        const reminderDateInput = document.getElementById('reminder-date');
        const reminderNotesInput = document.getElementById('reminder-notes');
        const reminderSubmitBtn = document.getElementById('reminder-submit-btn');
        const reminderCancelEditBtn = document.getElementById('reminder-cancel-edit-btn');
        const remindersTableBody = document.getElementById('reminders-table-body');
        const remindersSearchInput = document.getElementById('reminders-search');
        const remindersSortSelect = document.getElementById('reminders-sort');
        const noRemindersMessage = document.getElementById('no-reminders-message');

        // Funções de Utilitário
        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function displayAlert(messages) {
            customAlertMessage.innerHTML = messages.map(msg => `<li>${msg}</li>`).join('');
            customAlertModal.classList.remove('hidden');
            return new Promise(resolve => {
                customAlertOkButton.onclick = () => {
                    customAlertModal.classList.add('hidden');
                    resolve(true);
                };
            });
        }

        function displayConfirm(message) {
            customConfirmMessage.textContent = message;
            customConfirmModal.classList.remove('hidden');
            return new Promise(resolve => {
                customConfirmOkButton.onclick = () => {
                    customConfirmModal.classList.add('hidden');
                    resolve(true);
                };
                customConfirmCancelButton.onclick = () => {
                    customConfirmModal.classList.add('hidden');
                    resolve(false);
                };
            });
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
            return new Date(dateString).toLocaleDateString('pt-BR', options);
        }

        function calculateDaysRemaining(endDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time for accurate comparison
            const end = new Date(endDate);
            end.setHours(0, 0, 0, 0); // Reset time for accurate comparison
            const diffTime = end.getTime() - today.getTime();
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function setPage(page) {
            contractsSection.classList.add('hidden');
            remindersSection.classList.add('hidden');
            contractsNavBtn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
            remindersNavBtn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
            contractsNavBtn.classList.add('bg-gray-700', 'hover:bg-gray-600');
            remindersNavBtn.classList.add('bg-gray-700', 'hover:bg-gray-600');

            if (page === 'list') {
                contractsSection.classList.remove('hidden');
                contractsNavBtn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                contractsNavBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');
            } else if (page === 'reminders') {
                remindersSection.classList.remove('hidden');
                remindersNavBtn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                remindersNavBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');
            }
        }

        function updateGlobalAlerts(data, type) {
            let alerts = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (type === 'contract') {
                alerts = data.filter(item => {
                    const daysRemaining = calculateDaysRemaining(item.endDate);
                    return daysRemaining <= 30 && daysRemaining >= 0;
                }).map(item => `Contrato com ${item.client} (${item.type}) vence em ${formatDate(item.endDate)} (Faltam ${calculateDaysRemaining(item.endDate)} dias).`);
            } else if (type === 'reminder') {
                alerts = data.filter(item => {
                    const reminderDate = new Date(item.date);
                    reminderDate.setHours(0, 0, 0, 0);
                    return reminderDate.getTime() >= today.getTime(); // Future or today reminders
                }).sort((a, b) => new Date(a.date) - new Date(b.date))
                  .map(item => `Lembrete: ${item.title} em ${formatDate(item.date)}.`);
            }

            // Combine all active alerts
            const currentContractAlerts = globalAlertList.querySelectorAll('[data-type="contract-alert"]');
            const currentReminderAlerts = globalAlertList.querySelectorAll('[data-type="reminder-alert"]');

            // Clear previous alerts of the same type
            currentContractAlerts.forEach(el => el.remove());
            currentReminderAlerts.forEach(el => el.remove());

            // Add new alerts
            if (type === 'contract') {
                alerts.forEach(alert => {
                    const li = document.createElement('li');
                    li.textContent = alert;
                    li.setAttribute('data-type', 'contract-alert');
                    globalAlertList.appendChild(li);
                });
            } else if (type === 'reminder') {
                alerts.forEach(alert => {
                    const li = document.createElement('li');
                    li.textContent = alert;
                    li.setAttribute('data-type', 'reminder-alert');
                    globalAlertList.appendChild(li);
                });
            }

            const totalAlerts = globalAlertList.children.length;
            if (totalAlerts > 0) {
                globalAlerts.classList.remove('hidden');
            } else {
                globalAlerts.classList.add('hidden');
            }
        }


        // Funções de Contratos
        async function saveContract(event) {
            event.preventDefault();
            showLoading();

            const contract = {
                client: contractClientInput.value,
                type: contractTypeInput.value,
                startDate: contractStartDateInput.value,
                endDate: contractEndDateInput.value,
                value: parseFloat(contractValueInput.value),
                notes: contractNotesInput.value,
                userId: userId, // Associate contract with the logged-in user
                createdAt: currentEditingContractId ? contractsData.find(c => c.id === currentEditingContractId).createdAt : firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (currentEditingContractId) {
                    await contractsCollection.doc(currentEditingContractId).update(contract);
                    displayAlert(["Contrato atualizado com sucesso!"]);
                } else {
                    await contractsCollection.add(contract);
                    displayAlert(["Contrato adicionado com sucesso!"]);
                }
                resetContractForm();
            } catch (e) {
                console.error("Erro ao salvar contrato: ", e);
                displayAlert(["Erro ao salvar contrato. Tente novamente."]);
            } finally {
                hideLoading();
            }
        }

        function renderContracts(contracts) {
            contractsTableBody.innerHTML = '';
            noContractsMessage.classList.add('hidden');

            if (contracts.length === 0) {
                noContractsMessage.classList.remove('hidden');
                return;
            }

            contracts.forEach(contract => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');

                const daysRemaining = calculateDaysRemaining(contract.endDate);
                if (daysRemaining <= 30 && daysRemaining >= 0) {
                    row.classList.add('bg-yellow-100', 'animate-pulse-red');
                } else if (daysRemaining < 0) {
                    row.classList.add('bg-red-100');
                }

                row.innerHTML = `
                    <td class="py-3 px-6 text-left whitespace-nowrap">${contract.client}</td>
                    <td class="py-3 px-6 text-left">${contract.type}</td>
                    <td class="py-3 px-6 text-left">${formatDate(contract.startDate)}</td>
                    <td class="py-3 px-6 text-left">${formatDate(contract.endDate)}</td>
                    <td class="py-3 px-6 text-left">R$ ${contract.value.toFixed(2)}</td>
                    <td class="py-3 px-6 text-left">${contract.notes || '-'}</td>
                    <td class="py-3 px-6 text-center whitespace-nowrap">
                        <button class="edit-contract-btn bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-3 rounded text-xs mr-2" data-id="${contract.id}">Editar</button>
                        <button class="delete-contract-btn bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-xs" data-id="${contract.id}">Excluir</button>
                    </td>
                `;
                contractsTableBody.appendChild(row);
            });

            // Adiciona listeners para os botões de editar e excluir
            document.querySelectorAll('.edit-contract-btn').forEach(button => {
                button.addEventListener('click', editContract);
            });
            document.querySelectorAll('.delete-contract-btn').forEach(button => {
                button.addEventListener('click', deleteContract);
            });
        }

        function resetContractForm() {
            contractForm.reset();
            contractSubmitBtn.textContent = 'Adicionar Contrato';
            contractCancelEditBtn.classList.add('hidden');
            currentEditingContractId = null;
        }

        function editContract(event) {
            const id = event.target.dataset.id;
            const contract = contractsData.find(c => c.id === id);

            if (contract) {
                contractClientInput.value = contract.client;
                contractTypeInput.value = contract.type;
                contractStartDateInput.value = contract.startDate;
                contractEndDateInput.value = contract.endDate;
                contractValueInput.value = contract.value;
                contractNotesInput.value = contract.notes;

                contractSubmitBtn.textContent = 'Atualizar Contrato';
                contractCancelEditBtn.classList.remove('hidden');
                currentEditingContractId = id;

                // Scroll to form
                contractForm.scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function deleteContract(event) {
            const id = event.target.dataset.id;
            const confirm = await displayConfirm("Tem certeza que deseja excluir este contrato?");
            if (confirm) {
                showLoading();
                try {
                    await contractsCollection.doc(id).delete();
                    displayAlert(["Contrato excluído com sucesso!"]);
                } catch (e) {
                    console.error("Erro ao excluir contrato: ", e);
                    displayAlert(["Erro ao excluir contrato. Tente novamente."]);
                } finally {
                    hideLoading();
                }
            }
        }

        function filterAndSortContracts() {
            let filteredContracts = contractsData.filter(contract => {
                const searchTerm = contractsSearchInput.value.toLowerCase();
                return contract.client.toLowerCase().includes(searchTerm) ||
                       contract.type.toLowerCase().includes(searchTerm) ||
                       contract.notes.toLowerCase().includes(searchTerm);
            });

            const sortOption = contractsSortSelect.value;
            filteredContracts.sort((a, b) => {
                if (sortOption === 'endDateAsc') {
                    return new Date(a.endDate) - new Date(b.endDate);
                } else if (sortOption === 'endDateDesc') {
                    return new Date(b.endDate) - new Date(a.endDate);
                } else if (sortOption === 'clientAsc') {
                    return a.client.localeCompare(b.client);
                } else if (sortOption === 'clientDesc') {
                    return b.client.localeCompare(a.client);
                }
                return 0;
            });
            renderContracts(filteredContracts);
        }

        // Funções de Lembretes
        async function saveReminder(event) {
            event.preventDefault();
            showLoading();

            const reminder = {
                title: reminderTitleInput.value,
                date: reminderDateInput.value,
                notes: reminderNotesInput.value,
                userId: userId, // Associate reminder with the logged-in user
                createdAt: currentEditingReminderId ? remindersData.find(r => r.id === currentEditingReminderId).createdAt : firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (currentEditingReminderId) {
                    await remindersCollection.doc(currentEditingReminderId).update(reminder);
                    displayAlert(["Lembrete atualizado com sucesso!"]);
                } else {
                    await remindersCollection.add(reminder);
                    displayAlert(["Lembrete adicionado com sucesso!"]);
                }
                resetReminderForm();
            } catch (e) {
                console.error("Erro ao salvar lembrete: ", e);
                displayAlert(["Erro ao salvar lembrete. Tente novamente."]);
            } finally {
                hideLoading();
            }
        }

        function renderReminders(reminders) {
            remindersTableBody.innerHTML = '';
            noRemindersMessage.classList.add('hidden');

            if (reminders.length === 0) {
                noRemindersMessage.classList.remove('hidden');
                return;
            }

            reminders.forEach(reminder => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');

                const reminderDate = new Date(reminder.date);
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Reset time for accurate comparison

                if (reminderDate.getTime() < today.getTime()) {
                    row.classList.add('bg-gray-100', 'text-gray-400'); // Lembretes passados
                } else if (reminderDate.toDateString() === today.toDateString()) {
                    row.classList.add('bg-blue-100'); // Lembretes para hoje
                }

                row.innerHTML = `
                    <td class="py-3 px-6 text-left whitespace-nowrap">${reminder.title}</td>
                    <td class="py-3 px-6 text-left">${formatDate(reminder.date)}</td>
                    <td class="py-3 px-6 text-left">${reminder.notes || '-'}</td>
                    <td class="py-3 px-6 text-center whitespace-nowrap">
                        <button class="edit-reminder-btn bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-3 rounded text-xs mr-2" data-id="${reminder.id}">Editar</button>
                        <button class="delete-reminder-btn bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-xs" data-id="${reminder.id}">Excluir</button>
                    </td>
                `;
                remindersTableBody.appendChild(row);
            });

            // Adiciona listeners para os botões de editar e excluir
            document.querySelectorAll('.edit-reminder-btn').forEach(button => {
                button.addEventListener('click', editReminder);
            });
            document.querySelectorAll('.delete-reminder-btn').forEach(button => {
                button.addEventListener('click', deleteReminder);
            });
        }

        function resetReminderForm() {
            reminderForm.reset();
            reminderSubmitBtn.textContent = 'Adicionar Lembrete';
            reminderCancelEditBtn.classList.add('hidden');
            currentEditingReminderId = null;
        }

        function editReminder(event) {
            const id = event.target.dataset.id;
            const reminder = remindersData.find(r => r.id === id);

            if (reminder) {
                reminderTitleInput.value = reminder.title;
                reminderDateInput.value = reminder.date;
                reminderNotesInput.value = reminder.notes;

                reminderSubmitBtn.textContent = 'Atualizar Lembrete';
                reminderCancelEditBtn.classList.remove('hidden');
                currentEditingReminderId = id;

                // Scroll to form
                reminderForm.scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function deleteReminder(event) {
            const id = event.target.dataset.id;
            const confirm = await displayConfirm("Tem certeza que deseja excluir este lembrete?");
            if (confirm) {
                showLoading();
                try {
                    await remindersCollection.doc(id).delete();
                    displayAlert(["Lembrete excluído com sucesso!"]);
                } catch (e) {
                    console.error("Erro ao excluir lembrete: ", e);
                    displayAlert(["Erro ao excluir lembrete. Tente novamente."]);
                } finally {
                    hideLoading();
                }
            }
        }

        function filterAndSortReminders() {
            let filteredReminders = remindersData.filter(reminder => {
                const searchTerm = remindersSearchInput.value.toLowerCase();
                return reminder.title.toLowerCase().includes(searchTerm) ||
                       reminder.notes.toLowerCase().includes(searchTerm);
            });

            const sortOption = remindersSortSelect.value;
            filteredReminders.sort((a, b) => {
                if (sortOption === 'dateAsc') {
                    return new Date(a.date) - new Date(b.date);
                } else if (sortOption === 'dateDesc') {
                    return new Date(b.date) - new Date(a.date);
                } else if (sortOption === 'titleAsc') {
                    return a.title.localeCompare(b.title);
                } else if (sortOption === 'titleDesc') {
                    return b.title.localeCompare(a.title);
                }
                return 0;
            });
            renderReminders(filteredReminders);
        }

        // Configuração de Listeners Firebase
        function setupFirebaseListeners() {
            if (contractsUnsubscribe) {
                contractsUnsubscribe();
            }
            if (remindersUnsubscribe) {
                remindersUnsubscribe();
            }

            // Listen for contracts
            contractsUnsubscribe = contractsCollection
                .where('userId', '==', userId)
                .orderBy('endDate', 'asc')
                .onSnapshot(snapshot => {
                    contractsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    filterAndSortContracts(); // Render with current filters/sort
                    updateGlobalAlerts(contractsData, 'contract');
                }, error => {
                    console.error("Erro ao buscar contratos: ", error);
                    displayAlert(["Erro ao carregar contratos."]);
                });

            // Listen for reminders
            remindersUnsubscribe = remindersCollection
                .where('userId', '==', userId)
                .orderBy('date', 'asc')
                .onSnapshot(snapshot => {
                    remindersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    filterAndSortReminders(); // Render with current filters/sort
                    updateGlobalAlerts(remindersData, 'reminder');
                }, error => {
                    console.error("Erro ao buscar lembretes: ", error);
                    displayAlert(["Erro ao carregar lembretes."]);
                });
        }

        // Autenticação
        let isLoginMode = true; // true for login, false for register

        async function handleAuth() {
            showLoading();
            const email = emailInput.value;
            const password = passwordInput.value;

            if (!email || !password) {
                displayAlert(["Por favor, preencha todos os campos."]);
                hideLoading();
                return;
            }

            try {
                if (isLoginMode) {
                    await auth.signInWithEmailAndPassword(email, password);
                } else {
                    await auth.createUserWithEmailAndPassword(email, password);
                }
            } catch (error) {
                console.error("Erro de autenticação:", error);
                let errorMessage = "Erro de autenticação. Tente novamente.";
                if (error.code === 'auth/invalid-email') {
                    errorMessage = "Email inválido.";
                } else if (error.code === 'auth/user-disabled') {
                    errorMessage = "Usuário desabilitado.";
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Email ou senha incorretos.";
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Este email já está em uso.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "A senha deve ter pelo menos 6 caracteres.";
                }
                displayAlert([errorMessage]);
            } finally {
                hideLoading();
            }
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            if (isLoginMode) {
                authModeTitle.textContent = 'Login';
                authButton.textContent = 'Entrar';
                toggleAuthModeButton.textContent = 'Criar uma conta';
            } else {
                authModeTitle.textContent = 'Registrar';
                authButton.textContent = 'Registrar';
                toggleAuthModeButton.textContent = 'Já tenho uma conta';
            }
        }

        async function handleLogout() {
            const confirm = await displayConfirm("Tem certeza que deseja sair?");
            if (confirm) {
                showLoading();
                try {
                    await auth.signOut();
                    displayAlert(["Você foi desconectado."]);
                } catch (error) {
                    console.error("Erro ao sair:", error);
                    displayAlert(["Erro ao fazer logout. Tente novamente."]);
                } finally {
                    hideLoading();
                }
            }
        }

        // Event Listeners
        authButton.addEventListener('click', handleAuth);
        toggleAuthModeButton.addEventListener('click', toggleAuthMode);
        logoutButton.addEventListener('click', handleLogout);

        contractsNavBtn.addEventListener('click', () => setPage('list'));
        remindersNavBtn.addEventListener('click', () => setPage('reminders'));

        contractForm.addEventListener('submit', saveContract);
        contractCancelEditBtn.addEventListener('click', resetContractForm);
        contractsSearchInput.addEventListener('input', filterAndSortContracts);
        contractsSortSelect.addEventListener('change', filterAndSortContracts);

        reminderForm.addEventListener('submit', saveReminder);
        reminderCancelEditBtn.addEventListener('click', resetReminderForm);
        remindersSearchInput.addEventListener('input', filterAndSortReminders);
        remindersSortSelect.addEventListener('change', filterAndSortReminders);

        // Inicialização do aplicativo
        window.onload = () => {
            // === LINHAS MODIFICADAS: AJUSTE PARA NÃO FAZER LOGIN AUTOMÁTICO NA UI ===
            // Este onAuthStateChanged será executado se houver um usuário logado ou não.
            // A mudança aqui é forçar a exibição da tela de autenticação
            // mesmo que o usuário esteja logado no Firebase, para simular
            // a remoção do "login automático" na UI.
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Se o usuário está logado no Firebase, mas queremos que ele veja a tela de login
                    // A UI permanecerá na authScreen, e mainAppContent ficará escondido.
                    // As variáveis de estado `isLoggedIn`, `userId`, `userEmail`, `isAdmin`
                    // são resetadas para que a aplicação não se comporte como se estivesse logada.
                    isLoggedIn = false;
                    userId = '';
                    userEmail = '';
                    isAdmin = false;

                    authScreen.classList.remove('hidden'); // Garante que a tela de autenticação esteja visível
                    mainAppContent.classList.add('hidden'); // Garante que o conteúdo principal esteja escondido

                    // Se você realmente quer que o usuário faça logout em cada recarga, descomente a linha abaixo:
                    // signOut(auth);
                } else {
                    // Se não houver usuário logado no Firebase, mostre a tela de autenticação.
                    isLoggedIn = false;
                    userId = '';
                    userEmail = '';
                    isAdmin = false;
                    authScreen.classList.remove('hidden');
                    mainAppContent.classList.add('hidden');
                    // Limpa quaisquer dados existentes se o usuário sair
                    contractsData = [];
                    remindersData = [];
                    renderContracts([]);
                    renderReminders([]);
                    updateGlobalAlerts([], 'contract');
                    updateGlobalAlerts([], 'reminder');
                }
                hideLoading();
            });
        };
    </script>
</body>
</html>
